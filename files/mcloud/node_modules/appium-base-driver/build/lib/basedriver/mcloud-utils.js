"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

require("source-map-support/register");

var _fs = _interopRequireDefault(require("appium-support/build/lib/fs"));

var _path = _interopRequireDefault(require("path"));

var _axios = _interopRequireDefault(require("axios"));

var _logger = _interopRequireDefault(require("./logger"));

var _util = _interopRequireDefault(require("util"));

var _child_process = require("child_process");

async function getLocalAppsFolder() {
  return process.env.APPIUM_APPS_DIR;
}

async function getSharedFolderForAppUrl(url) {
  const sub = await getLocalFileForAppUrl(url);
  const lastSlashInd = sub.lastIndexOf(_path.default.sep);
  var targetPath;

  if (lastSlashInd != -1) {
    targetPath = sub.substring(0, lastSlashInd);
  } else {
    targetPath = '';
  }

  _logger.default.info(`[MCLOUD] Target path [getSharedFolderForAppUrl]: ${targetPath}`);

  const folderExists = await _fs.default.exists(targetPath);
  if (!folderExists) await _fs.default.mkdir(targetPath, {
    recursive: true
  });
  return targetPath;
}

async function getLocalFileForAppUrl(url) {
  var sub = url.substring(url.indexOf('//') + 2);
  sub = sub.substring(sub.indexOf('/'));

  if (sub.includes('?')) {
    sub = sub.substring(0, sub.indexOf('?'));
  }

  sub = sub.replace(/\//g, _path.default.sep);

  const targetPath = _path.default.join(await getLocalAppsFolder(), sub);

  _logger.default.info(`[MCLOUD] Target path [getLocalFileForAppUrl]: ${targetPath}`);

  return targetPath;
}

async function getFileContentLength(remoteUrl) {
  const timeout = 10000;
  const retries = 5;
  const pollingInterval = 3000;
  const check_app_size_optionally = process.env.CHECK_APP_SIZE_OPTIONALLY;

  _logger.default.info(`[MCLOUD] env CHECK_APP_SIZE_OPTIONALLY=${check_app_size_optionally}`);

  const requestOpts = {
    url: remoteUrl,
    responseType: 'stream',
    timeout
  };
  var lastError;

  const getLengthRequest = async () => {
    for (var i = 0; i < retries; i++) {
      try {
        _logger.default.debug(`[MCLOUD] Making GET http call for retrieving of remote app size`);

        const {
          headers: responseHeaders
        } = await (0, _axios.default)(requestOpts);
        const responseLength = parseInt(responseHeaders['content-length'], 10);

        _logger.default.debug(`[MCLOUD] CONTENT-LENGTH for the file: ${responseLength}`);

        return responseLength;
      } catch (error) {
        lastError = error;
        console.log(`[MCLOUD] Cannot fetch info about app size. Will retry attempt in ${pollingInterval}ms`);
        await new Promise(resolve => setTimeout(resolve, pollingInterval));
      }
    }
  };

  const length = await getLengthRequest();

  if (length) {
    return length;
  } else if (check_app_size_optionally !== undefined && check_app_size_optionally === 'true') {
    _logger.default.debug(`[MCLOUD] Returning app size as undefined`);

    return undefined;
  } else {
    throw new Error(`[MCLOUD] Cannot get file content-length from ${remoteUrl} after ${retries} retry(s): ${lastError}`);
  }
}

function executeShell(shellCommand, description) {
  (0, _child_process.exec)(shellCommand, (error, stdout, stderr) => {
    if (error) {
      _logger.default.info(`[MCLOUD] ${description} error: ${error.message}`);

      return;
    }

    if (stderr) {
      _logger.default.info(`[MCLOUD] ${description} stderr: ${stderr}`);

      return;
    }

    _logger.default.info(`[MCLOUD] ${description} command was successfully executed`);
  });
}

async function executeShellWPromise(shellCommand) {
  const execPromisify = _util.default.promisify(_child_process.exec);

  return await execPromisify(shellCommand);
}

async function parseWDAUrl() {
  const wdaHost = process.env.WDA_HOST;
  const wdaPort = process.env.WDA_PORT;

  return `http://${wdaHost}:${wdaPort}/status`;
}

async function getWDAStatus(wdaURL) {
  try {
    return (await (0, _axios.default)({
      url: wdaURL,
      method: 'GET',
      timeout: 500
    })).data;
  } catch (e) {
    _logger.default.info(`Cannot send GET request to '${wdaURL}'. Original error: ${e.message}`);

    return undefined;
  }
}

module.exports = {
  getLocalAppsFolder,
  getSharedFolderForAppUrl,
  getLocalFileForAppUrl,
  getFileContentLength,
  executeShell,
  executeShellWPromise,
  parseWDAUrl,
  getWDAStatus
};require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL21jbG91ZC11dGlscy5qcyJdLCJuYW1lcyI6WyJnZXRMb2NhbEFwcHNGb2xkZXIiLCJwcm9jZXNzIiwiZW52IiwiQVBQSVVNX0FQUFNfRElSIiwiZ2V0U2hhcmVkRm9sZGVyRm9yQXBwVXJsIiwidXJsIiwic3ViIiwiZ2V0TG9jYWxGaWxlRm9yQXBwVXJsIiwibGFzdFNsYXNoSW5kIiwibGFzdEluZGV4T2YiLCJwYXRoIiwic2VwIiwidGFyZ2V0UGF0aCIsInN1YnN0cmluZyIsImxvZ2dlciIsImluZm8iLCJmb2xkZXJFeGlzdHMiLCJmcyIsImV4aXN0cyIsIm1rZGlyIiwicmVjdXJzaXZlIiwiaW5kZXhPZiIsImluY2x1ZGVzIiwicmVwbGFjZSIsIm5vZGVQYXRoIiwiam9pbiIsImdldEZpbGVDb250ZW50TGVuZ3RoIiwicmVtb3RlVXJsIiwidGltZW91dCIsInJldHJpZXMiLCJwb2xsaW5nSW50ZXJ2YWwiLCJjaGVja19hcHBfc2l6ZV9vcHRpb25hbGx5IiwiQ0hFQ0tfQVBQX1NJWkVfT1BUSU9OQUxMWSIsInJlcXVlc3RPcHRzIiwicmVzcG9uc2VUeXBlIiwibGFzdEVycm9yIiwiZ2V0TGVuZ3RoUmVxdWVzdCIsImkiLCJkZWJ1ZyIsImhlYWRlcnMiLCJyZXNwb25zZUhlYWRlcnMiLCJyZXNwb25zZUxlbmd0aCIsInBhcnNlSW50IiwiZXJyb3IiLCJjb25zb2xlIiwibG9nIiwiUHJvbWlzZSIsInJlc29sdmUiLCJzZXRUaW1lb3V0IiwibGVuZ3RoIiwidW5kZWZpbmVkIiwiRXJyb3IiLCJleGVjdXRlU2hlbGwiLCJzaGVsbENvbW1hbmQiLCJkZXNjcmlwdGlvbiIsInN0ZG91dCIsInN0ZGVyciIsIm1lc3NhZ2UiLCJleGVjdXRlU2hlbGxXUHJvbWlzZSIsImV4ZWNQcm9taXNpZnkiLCJ1dGlsIiwicHJvbWlzaWZ5IiwiZXhlYyIsInBhcnNlV0RBVXJsIiwid2RhRW52IiwiV0RBX0VOViIsIndkYUVudkNvbnRlbnQiLCJyZWFkRmlsZSIsInJlZ2V4SG9zdCIsIlJlZ0V4cCIsImhvc3QiLCJyIiwiU3RyaW5nIiwibWF0Y2giLCJyZWdleFBvcnQiLCJwb3J0IiwiZ2V0V0RBU3RhdHVzIiwid2RhVVJMIiwibWV0aG9kIiwiZGF0YSIsImUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFFQSxlQUFlQSxrQkFBZixHQUFvQztBQUNoQyxTQUFPQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsZUFBbkI7QUFDSDs7QUFFRCxlQUFlQyx3QkFBZixDQUF3Q0MsR0FBeEMsRUFBNkM7QUFDekMsUUFBTUMsR0FBRyxHQUFHLE1BQU1DLHFCQUFxQixDQUFDRixHQUFELENBQXZDO0FBRUEsUUFBTUcsWUFBWSxHQUFHRixHQUFHLENBQUNHLFdBQUosQ0FBZ0JDLGNBQUtDLEdBQXJCLENBQXJCO0FBQ0EsTUFBSUMsVUFBSjs7QUFDQSxNQUFHSixZQUFZLElBQUksQ0FBQyxDQUFwQixFQUF1QjtBQUNuQkksSUFBQUEsVUFBVSxHQUFHTixHQUFHLENBQUNPLFNBQUosQ0FBYyxDQUFkLEVBQWlCTCxZQUFqQixDQUFiO0FBQ0gsR0FGRCxNQUVPO0FBQ0hJLElBQUFBLFVBQVUsR0FBRyxFQUFiO0FBQ0g7O0FBRURFLGtCQUFPQyxJQUFQLENBQWEsb0RBQW1ESCxVQUFXLEVBQTNFOztBQUNBLFFBQU1JLFlBQVksR0FBRyxNQUFNQyxZQUFHQyxNQUFILENBQVVOLFVBQVYsQ0FBM0I7QUFDQSxNQUFHLENBQUNJLFlBQUosRUFDSSxNQUFNQyxZQUFHRSxLQUFILENBQVNQLFVBQVQsRUFBcUI7QUFBQ1EsSUFBQUEsU0FBUyxFQUFHO0FBQWIsR0FBckIsQ0FBTjtBQUVKLFNBQU9SLFVBQVA7QUFDSDs7QUFFRCxlQUFlTCxxQkFBZixDQUFxQ0YsR0FBckMsRUFBMEM7QUFDdEMsTUFBSUMsR0FBRyxHQUFHRCxHQUFHLENBQUNRLFNBQUosQ0FBY1IsR0FBRyxDQUFDZ0IsT0FBSixD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LENBQUQsQ0FBUjtBQUNKLFdBQVEsVUFBU0QsSUFBSyxJQUFHSyxJQUFLLFNBQTlCO0FBQ0g7O0FBQ0QsU0FBT3pCLFNBQVA7QUFDSDs7QUFFRCxlQUFlMEIsWUFBZixDQUE0QkMsTUFBNUIsRUFBb0M7QUFDaEMsTUFBSTtBQUNBLFdBQU8sQ0FBQyxNQUFNLG9CQUFNO0FBQ2xCeEUsTUFBQUEsR0FBRyxFQUFFd0UsTUFEYTtBQUVsQkMsTUFBQUEsTUFBTSxFQUFFLEtBRlU7QUFHbEJsRCxNQUFBQSxPQUFPLEVBQUU7QUFIUyxLQUFOLENBQVAsRUFJSG1ELElBSko7QUFLRCxHQU5ILENBTUksT0FBT0MsQ0FBUCxFQUFVO0FBQ1ZsRSxvQkFBT0MsSUFBUCxDQUFhLCtCQUE4QjhELE1BQU8sc0JBQXFCRyxDQUFDLENBQUN2QixPQUFRLEVBQWpGOztBQUNBLFdBQU9QLFNBQVA7QUFDRDtBQUNOOztBQUVEK0IsTUFBTSxDQUFDQyxPQUFQLEdBQWlCO0FBQUVsRixFQUFBQSxrQkFBRjtBQUFzQkksRUFBQUEsd0JBQXRCO0FBQWdERyxFQUFBQSxxQkFBaEQ7QUFBdUVtQixFQUFBQSxvQkFBdkU7QUFBNkYwQixFQUFBQSxZQUE3RjtBQUEyR00sRUFBQUEsb0JBQTNHO0FBQWlJSyxFQUFBQSxXQUFqSTtBQUE4SWEsRUFBQUE7QUFBOUksQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnYXBwaXVtLXN1cHBvcnQvYnVpbGQvbGliL2ZzJztcbmltcG9ydCBub2RlUGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBheGlvcyBmcm9tICdheGlvcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHV0aWwgZnJvbSAndXRpbCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5cbmFzeW5jIGZ1bmN0aW9uIGdldExvY2FsQXBwc0ZvbGRlcigpIHtcbiAgICByZXR1cm4gcHJvY2Vzcy5lbnYuQVBQSVVNX0FQUFNfRElSO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRTaGFyZWRGb2xkZXJGb3JBcHBVcmwodXJsKSB7XG4gICAgY29uc3Qgc3ViID0gYXdhaXQgZ2V0TG9jYWxGaWxlRm9yQXBwVXJsKHVybCk7XG5cbiAgICBjb25zdCBsYXN0U2xhc2hJbmQgPSBzdWIubGFzdEluZGV4T2YocGF0aC5zZXApO1xuICAgIHZhciB0YXJnZXRQYXRoO1xuICAgIGlmKGxhc3RTbGFzaEluZCAhPSAtMSkge1xuICAgICAgICB0YXJnZXRQYXRoID0gc3ViLnN1YnN0cmluZygwLCBsYXN0U2xhc2hJbmQpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRhcmdldFBhdGggPSAnJztcbiAgICB9XG5cbiAgICBsb2dnZXIuaW5mbyhgW01DTE9VRF0gVGFyZ2V0IHBhdGggW2dldFNoYXJlZEZvbGRlckZvckFwcFVybF06ICR7dGFyZ2V0UGF0aH1gKVxuICAgIGNvbnN0IGZvbGRlckV4aXN0cyA9IGF3YWl0IGZzLmV4aXN0cyh0YXJnZXRQYXRoKTtcbiAgICBpZighZm9sZGVyRXhpc3RzKVxuICAgICAgICBhd2FpdCBmcy5ta2Rpcih0YXJnZXRQYXRoLCB7cmVjdXJzaXZlIDogdHJ1ZX0pO1xuICBcbiAgICByZXR1cm4gdGFyZ2V0UGF0aDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0TG9jYWxGaWxlRm9yQXBwVXJsKHVybCkge1xuICAgIHZhciBzdWIgPSB1cmwuc3Vic3RyaW5nKHVybC5pbmRleE9mKCcvLycpICsgMilcbiAgICBzdWIgPSBzdWIuc3Vic3RyaW5nKHN1Yi5pbmRleE9mKCcvJykpO1xuICAgIGlmKHN1Yi5pbmNsdWRlcygnPycpKSB7XG4gICAgICAgIHN1YiA9IHN1Yi5zdWJzdHJpbmcoMCwgc3ViLmluZGV4T2YoJz8nKSk7XG4gICAgfVxuICAgIHN1YiA9IHN1Yi5yZXBsYWNlKC9cXC8vZywgcGF0aC5zZXApO1xuXG4gICAgY29uc3QgdGFyZ2V0UGF0aCA9IG5vZGVQYXRoLmpvaW4oYXdhaXQgZ2V0TG9jYWxBcHBzRm9sZGVyKCksIHN1Yik7XG4gICAgbG9nZ2VyLmluZm8oYFtNQ0xPVURdIFRhcmdldCBwYXRoIFtnZXRMb2NhbEZpbGVGb3JBcHBVcmxdOiAke3RhcmdldFBhdGh9YClcbiAgICByZXR1cm4gdGFyZ2V0UGF0aDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RmlsZUNvbnRlbnRMZW5ndGgocmVtb3RlVXJsKSB7XG4gICAgY29uc3QgdGltZW91dCA9IDEwMDAwO1xuICAgIGNvbnN0IHJldHJpZXMgPSA1O1xuICAgIGNvbnN0IHBvbGxpbmdJbnRlcnZhbCA9IDMwMDA7XG4gICAgY29uc3QgY2hlY2tfYXBwX3NpemVfb3B0aW9uYWxseSA9IHByb2Nlc3MuZW52LkNIRUNLX0FQUF9TSVpFX09QVElPTkFMTFk7XG4gICAgbG9nZ2VyLmluZm8oYFtNQ0xPVURdIGVudiBDSEVDS19BUFBfU0laRV9PUFRJT05BTExZPSR7Y2hlY2tfYXBwX3NpemVfb3B0aW9uYWxseX1gKTtcblxuICAgIGNvbnN0IHJlcXVlc3RPcHRzID0ge1xuICAgICAgICB1cmw6IHJlbW90ZVVybCxcbiAgICAgICAgcmVzcG9uc2VUeXBlOiAnc3RyZWFtJyxcbiAgICAgICAgdGltZW91dCxcbiAgICB9O1xuXG4gICAgLy8gZ2V0dGluZyBjb250ZW50LWxlbmd0aCB3aXRoIHJldHJ5XG4gICAgdmFyIGxhc3RFcnJvcjtcbiAgICBjb25zdCBnZXRMZW5ndGhSZXF1ZXN0ID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICBmb3IgKHZhciBpPTA7IGk8cmV0cmllczsgaSsrKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhgW01DTE9VRF0gTWFraW5nIEdFVCBodHRwIGNhbGwgZm9yIHJldHJpZXZpbmcgb2YgcmVtb3RlIGFwcCBzaXplYCk7XG4gICAgICAgICAgICAgICAgY29uc3Qge1xuICAgICAgICAgICAgICAgICAgICBoZWFkZXJzOiByZXNwb25zZUhlYWRlcnMsXG4gICAgICAgICAgICAgICAgfSA9IGF3YWl0IGF4aW9zKHJlcXVlc3RPcHRzKTtcbiAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZUxlbmd0aCA9IHBhcnNlSW50KHJlc3BvbnNlSGVhZGVyc1snY29udGVudC1sZW5ndGgnXSwgMTApO1xuICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhgW01DTE9VRF0gQ09OVEVOVC1MRU5HVEggZm9yIHRoZSBmaWxlOiAke3Jlc3BvbnNlTGVuZ3RofWApO1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZUxlbmd0aDtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgbGFzdEVycm9yID0gZXJyb3I7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFtNQ0xPVURdIENhbm5vdCBmZXRjaCBpbmZvIGFib3V0IGFwcCBzaXplLiBXaWxsIHJldHJ5IGF0dGVtcHQgaW4gJHtwb2xsaW5nSW50ZXJ2YWx9bXNgKTtcbiAgICAgICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgcG9sbGluZ0ludGVydmFsKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgbGVuZ3RoID0gYXdhaXQgZ2V0TGVuZ3RoUmVxdWVzdCgpO1xuICAgIGlmKGxlbmd0aCkge1xuICAgICAgICByZXR1cm4gbGVuZ3RoO1xuICAgIH0gZWxzZSBpZiAoY2hlY2tfYXBwX3NpemVfb3B0aW9uYWxseSAhPT0gdW5kZWZpbmVkICYmIGNoZWNrX2FwcF9zaXplX29wdGlvbmFsbHkgPT09ICd0cnVlJykge1xuICAgICAgICBsb2dnZXIuZGVidWcoYFtNQ0xPVURdIFJldHVybmluZyBhcHAgc2l6ZSBhcyB1bmRlZmluZWRgKTtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFtNQ0xPVURdIENhbm5vdCBnZXQgZmlsZSBjb250ZW50LWxlbmd0aCBmcm9tICR7cmVtb3RlVXJsfSBhZnRlciAke3JldHJpZXN9IHJldHJ5KHMpOiAke2xhc3RFcnJvcn1gKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGV4ZWN1dGVTaGVsbChzaGVsbENvbW1hbmQsIGRlc2NyaXB0aW9uKSB7XG4gICAgZXhlYyhzaGVsbENvbW1hbmQsIChlcnJvciwgc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyhgW01DTE9VRF0gJHtkZXNjcmlwdGlvbn0gZXJyb3I6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc3RkZXJyKSB7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyhgW01DTE9VRF0gJHtkZXNjcmlwdGlvbn0gc3RkZXJyOiAke3N0ZGVycn1gKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBsb2dnZXIuaW5mbyhgW01DTE9VRF0gJHtkZXNjcmlwdGlvbn0gY29tbWFuZCB3YXMgc3VjY2Vzc2Z1bGx5IGV4ZWN1dGVkYCk7XG4gICAgICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZXhlY3V0ZVNoZWxsV1Byb21pc2Uoc2hlbGxDb21tYW5kKSB7XG4gICAgY29uc3QgZXhlY1Byb21pc2lmeSA9IHV0aWwucHJvbWlzaWZ5KGV4ZWMpO1xuICAgIHJldHVybiBhd2FpdCBleGVjUHJvbWlzaWZ5KHNoZWxsQ29tbWFuZCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBhcnNlV0RBVXJsKCkge1xuICAgIGNvbnN0IHdkYUVudiA9IHByb2Nlc3MuZW52LldEQV9FTlY7XG4gICAgaWYgKHdkYUVudikge1xuICAgICAgICBjb25zdCB3ZGFFbnZDb250ZW50ID0gYXdhaXQgZnMucmVhZEZpbGUod2RhRW52KTtcbiAgICAgICAgY29uc3QgcmVnZXhIb3N0ID0gbmV3IFJlZ0V4cCgnZXhwb3J0IFdEQV9IT1NUPSguKiknKTtcbiAgICAgICAgdmFyIGhvc3Q7XG4gICAgICAgIHZhciByID0gU3RyaW5nKHdkYUVudkNvbnRlbnQpLm1hdGNoKHJlZ2V4SG9zdCk7XG4gICAgICAgIGlmIChyKVxuICAgICAgICAgICAgaG9zdCA9IHJbMV07IFxuICAgICAgICBjb25zdCByZWdleFBvcnQgPSBuZXcgUmVnRXhwKCdleHBvcnQgV0RBX1BPUlQ9KC4qKScpO1xuICAgICAgICB2YXIgcG9ydDtcbiAgICAgICAgdmFyIHIgPSBTdHJpbmcod2RhRW52Q29udGVudCkubWF0Y2gocmVnZXhQb3J0KTtcbiAgICAgICAgaWYgKHIpXG4gICAgICAgICAgICBwb3J0ID0gclsxXTsgXG4gICAgICAgIHJldHVybiBgaHR0cDovLyR7aG9zdH06JHtwb3J0fS9zdGF0dXNgO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRXREFTdGF0dXMod2RhVVJMKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIChhd2FpdCBheGlvcyh7XG4gICAgICAgICAgdXJsOiB3ZGFVUkwsXG4gICAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgICB0aW1lb3V0OiA1MDAwLFxuICAgICAgICB9KSkuZGF0YTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oYENhbm5vdCBzZW5kIEdFVCByZXF1ZXN0IHRvICcke3dkYVVSTH0nLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0geyBnZXRMb2NhbEFwcHNGb2xkZXIsIGdldFNoYXJlZEZvbGRlckZvckFwcFVybCwgZ2V0TG9jYWxGaWxlRm9yQXBwVXJsLCBnZXRGaWxlQ29udGVudExlbmd0aCwgZXhlY3V0ZVNoZWxsLCBleGVjdXRlU2hlbGxXUHJvbWlzZSwgcGFyc2VXREFVcmwsIGdldFdEQVN0YXR1cyB9Il0sImZpbGUiOiJsaWIvYmFzZWRyaXZlci9tY2xvdWQtdXRpbHMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
